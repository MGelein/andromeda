"use strict";var andromeda={version:0.1,author:"Mees Gelein"};(function(j){var u="http://www.perseus.tufts.edu/hopper/loadquery";var h="http://www.perseus.tufts.edu/hopper/searchresults?q=";var i="http://www.perseus.tufts.edu/hopper/";var v=10;var g="<div class='row'><hr><div class='col-sm-12 text-center'><h4>Navigation</h4></div><div class='col-sm-5 text-center'><span id='prevSeg' class='btn btn-sm btn-xs btn-outline-secondary disabled noPointer'>◀&nbsp;Previous Segment</span></div><div class='col-sm-2 text-center'><span id='newSeg' class='btn btn-sm btn-xs btn-outline-primary'>New Query</span></div><div class='col-sm-5 text-center'><span id='nextSeg' class='btn btn-sm btn-xs btn-outline-secondary disabled noPointer'>&nbsp;Next Segment&nbsp;▶</span></div><hr><div class='col-sm-12 text-center'><h4>Save &amp; Load</h4></div><div class='col-sm-1'></div><div class='col-sm-4 text-center'><span id='saveButton' class='btn btn-sm btn-xs btn-outline-primary btn-block'>Save</span></div><div class='col-sm-2 '></div><div class='col-sm-4 text-center'><span id='loadButton' class='btn btn-sm btn-xs btn-outline-primary btn-block'>Load</span></div><hr><div class='col-sm-1'></div></div>";var t=function(F,H,E){if(E==undefined){E=true}var G=H.val().trim();H.val("");if(G.length==0){return}F.val("Loading...").removeClass("btn-primary").addClass("btn-warning");var D=G;if(!G.startsWith("http")){D=h+encodeURI(G)}if(E){$("#noteContent").html("");$("#dictionaryContent").html("")}f(D)};var f=function(D){j.environment.translations=[];j.environment.text={};$.ajax({url:D,success:function(N){if(N.indexOf("<title>Perseus Search results</title>")!=-1||N.indexOf('<link href="/js/perseusld/perseusld.css" rel="stylesheet" type="text/css"/>')==-1){var E=$("#newSegDiv").find("#newSegQueryButton");E.val("Not A Know Text").removeClass("btn-warning").addClass("btn-danger");$("#loadFromPerseusButton").val("Not A Known Text").removeClass("btn-warning").addClass("btn-danger");setTimeout(function(){E.val("Load From Perseus").removeClass("btn-danger").addClass("btn-primary");$("#loadFromPerseusButton").val("Load From Perseus").removeClass("btn-danger").addClass("btn-primary")},2000)}else{$($("#newSegDiv").fadeOut()).promise().done(function(){var O=$("#newSegDiv").find("#newSegQueryButton");O.val("Load From Perseus").removeClass("btn-warning").addClass("btn-primary")});N=N.replace(/<img/g,"<span");var I=$(N);j.environment.text.locus="";I.find(".current").each(function(P,Q){var O=$(Q).attr("title");O=j.util.ucfirst(O);O=O.trim();if(O.indexOf("ection")!=-1){j.environment.text.locus+=O.replace("Section ",".")}else{j.environment.text.locus+=", "+O}});j.environment.text.locus=j.environment.text.locus.substr(2);j.environment.text.shortcut=I.find('#header_jump_form > input[name="doc"]').val();var J=I.find(".current").filter(":last").get(0);j.environment.text.doc=u+$(J).attr("href");var M=$(I.find("#header_text").get(0)).find("h1").get(0).textContent;j.environment.text.title=M.replace(/[\s]/g," ").replace(/\s\s+/g," ").trim();var L=I.find('.arrow span[alt="next"]').get(0);var G=I.find('.arrow span[alt="previous"]').get(0);if(L!=undefined){j.environment.text.next=i+$(L).parent().attr("href")}else{j.environment.text.next=undefined}if(G!=undefined){j.environment.text.prev=i+$(G).parent().attr("href")}else{j.environment.text.prev=undefined}s();var H=0;while(true){var F=I.find("#translation"+H+" .header");if(F.length<1){break}var K=F.get(0);j.environment.translations.push({title:K.textContent.split("\n")[3],doc:u+$($(K).find(".toggle").get(1)).attr("href").replace("text","")});H++}w()}$(".greyed-out").removeClass("greyed-out");m()}})};var C=function(D,E){$("#translationContent").html(D);$("#translationHeader").html('Translation: <span class="titleName">'+E+"</span>")};var w=function(){$("#translationContent").html("");j.environment.translations.dropdown="";$.each(j.environment.translations,function(D,E){$.ajax({url:E.doc,success:function(F){F=F.replace(/<hr[^>]*>/g,"");F=F.replace(/<img[^>]*>/g,"");E.data=F;j.environment.translations.dropdown+="<div class='dropdownLink' resultIndex='"+D+"'><span class='dropdownIcon'/>"+E.title+"</div>";if(D==0){C(F,E.title)}}})});$("#translationHeader").unbind("click").click(function(E){E.stopPropagation();var D=$("#headerDropdown");if(!j.ui.dropdownShowing){j.ui.dropdownShowing=true;var F=function(){var G=$("#translationHeader");var H=G.offset();D.offset({top:0,left:0});D.html(j.environment.translations.dropdown);D.offset({top:H.top+G.height(),left:H.left});D.innerWidth(G.outerWidth())};F();$(window).unbind("resize").resize(F);$(document).click(function(){m()});D.find(".dropdownLink").each(function(G,H){if($("#translationHeader").text().indexOf($(H).text())==-1){return}$($(H).find(".dropdownIcon").get(0)).addClass("dropdownActiveIcon")});D.fadeIn();D.find(".dropdownLink").click(function(G){C(j.environment.translations[$(this).attr("resultIndex")].data,$(this).text())})}else{m()}})};var m=function(){var D=$("#headerDropdown");$(window).unbind("resize");$(document).unbind("click");j.ui.dropdownShowing=false;D.html("");D.offset({top:0,left:0});D.innerWidth(0);D.hide()};var A=function(D){var E=j.util.getSelected();if(E.isCollapsed){a();return}var F=E.anchorNode;var I=E.focusNode;if(E.toString().trim().length==0){return}if(F.compareDocumentPosition(I)==2){var H=I;I=F;F=H}var K=d(F);var J=$("#addNote");var L={locus:K,text:E.toString()};j.environment.note.toAdd=L;var G=function(){if($(F.parentNode).is("a")){F=F.parentNode}var M=$(F);if(!M.is("a")){M=M.prev()}var N=M.offset();if(N==undefined){return}J.offset({top:0,left:0});J.offset({top:N.top-M.height()*2,left:N.left})};G();$(window).unbind("resize").resize(G);$(document).mousedown(a);J.fadeIn()};var x=function(F){if(F!=undefined){F.stopPropagation()}a();var E=j.environment.note.toAdd;var H=E.text;H=H.replace(/[\n\r]/g," ");E.text=H;var G=H.split(" ");var D=H;if(G.length>4){D=G[0]+" "+G[1]+"[..]"+G[G.length-2]+" "+G[G.length-1]}E.blurb=D;if(F!=undefined){E.type="user"}c(E)};var c=function(F){if(j.environment.note.all.indexOf(F)==-1){F.id=-1;while(true){F.id++;var E=false;$.each(j.environment.note.all,function(K,L){if(F.id==L.id){E=true;return false}});if(!E){break}}j.environment.note.all.push(F)}var I=F.locus.replace(/ /g,"_").split(".");var J=I[0].split(",_");if(I.length>1){J.push(I[1])}var H="secondLevel";if(J.length==2){H="thirdLevel"}$.each(J,function(L,K){if(L==0){if($("#noteContent").find("#note-"+K).length==0){$("#noteContent").append('<div class="topLevel" id="note-'+K+'"><span class="collapseButton text-primary">▼</span><h5>'+K.replace("_"," ")+"</h5></div>");$("#noteContent").find(".topLevel").sort(function(O,M){var P=$(O).find("h5").get(0).textContent;var N=$(M).find("h5").get(0).textContent;return b(P,N)}).appendTo($("#noteContent"))}}else{if(L==1){if($("#noteContent").find("#note-"+J[0]+"-"+K).length==0){$("#noteContent").find("#note-"+J[0]).append('<div class="'+H+'" id="note-'+J[0]+"-"+K+'"><span class="level2Name">'+K.replace("_"," ")+'</span><span class="collapseButton text-primary">▼</span></div>');$("#note-"+J[0]).find("."+H).sort(function(O,M){var P=$(O).find(".level2Name").get(0).textContent;var N=$(M).find(".level2Name").get(0).textContent;return b(P,N)}).appendTo($("#note-"+J[0]))}}else{if(L==2){if($("#noteContent").find("#note-"+J[0]+"-"+J[1]+"-"+K).length==0){$("#noteContent").find("#note-"+J[0]+"-"+J[1]).append('<div class="thirdLevel" id="note-'+J[0]+"-"+J[1]+"-"+K+'"><span class="level3Name">'+K.replace("_","")+'</span><span class="collapseButton text-primary">▼</span></div>');$("#note-"+J[0]+"-"+J[1]).find(".thirdLevel").sort(function(O,M){var P=$(O).find(".level3Name").get(0).textContent;var N=$(M).find(".level3Name").get(0).textContent;return b(P,N)}).appendTo($("#note-"+J[0]+"-"+J[1]))}}}}});$(".collapseButton").unbind("click").click(function(K){if($(this).text()=="▼"){$(this).parent().find("> div").fadeOut();$(this).text("▶")}else{$(this).parent().find("> div").fadeIn();$(this).text("▼")}});var D="note-"+J.join("-");if(F.data==undefined||F.data.length<1){F.data="[Click To Edit]"}$("#"+D).append('<div class="note" note-id="'+F.id+'"><div class="noteLemma">'+F.blurb+'&nbsp;:&nbsp;<button class="float-right btn btn-outline-primary btn-sm btn-xs removeNoteButton" onclick="andromeda.search.removeNote(this)">✖</button></div><div class="noteData">'+F.data+"</div></div>");var G=$("#"+D).find(".collapseButton");if(G.text()=="▶"){G.click()}$(".noteData").unbind("click").click(function(K){$(this).attr("contenteditable","true");$(this).keydown(function(P){if(P.keyCode==13&&!P.shiftKey){var O=$(this).parent().attr("note-id");var M,L=j.environment.note.all.length,N;for(M=0;M<L;M++){if(j.environment.note.all[M].id==O){j.environment.note.all[M].data=$(this).html()}}$(this).attr("contenteditable","false")}});$(this).unbind("focusout").focusout(function(P){$(this).attr("contenteditable","false");var O=$(this).parent().attr("note-id");var M,L=j.environment.note.all.length,N;for(M=0;M<L;M++){if(j.environment.note.all[M].id==O){$(this).html(j.environment.note.all[M].data)}}})});console.log(F.type);if(F.type=="dict"){return}$("#"+D).find('div[note-id="'+F.id+'"]').find(".noteData").click();setTimeout(function(){var L=$("#"+D).find('div[note-id="'+F.id+'"]').find(".noteData").get(0);L.focus();if(document.selection){var K=document.body.createTextRange();K.moveToElementText(L);K.select()}else{if(window.getSelection){var K=document.createRange();K.selectNodeContents(L);window.getSelection().removeAllRanges();window.getSelection().addRange(K)}}},200)};var e=function(F){var H=$(F).parent().parent();var G=H.attr("note-id");while(H.parent().find(".note").length==1&&H.parent().attr("id")!="noteContent"){H=H.parent()}H.fadeOut().promise().done(function(){this.remove()});var E=0;var D=j.environment.note.all.length;var I;for(E=0;E<D;E++){I=j.environment.note.all[E];if(I.id==G){j.environment.note.all.splice(E,1)}}};var b=function(J,I){var G=J.split(" ");var E=I.split(" ");var F,H;for(var D=0;D<G.length;D++){H=G[D];F=E[D];if(isNaN(H)||isNaN(F)){if(H<F){return -1}if(H>F){return 1}}else{var L=parseFloat(H);var K=parseFloat(F);if(L<K){return -1}if(L>K){return 1}}}return 0};var a=function(){var D=$("#addNote");D.offset({top:0,left:0});D.hide();$(document).unbind("mousedown");$(window).unbind("resize");if(window.getSelection){if(window.getSelection().empty){window.getSelection().empty()}else{if(window.getSelection().removeAllRanges){window.getSelection().removeAllRanges()}}}else{if(document.selection){document.selection.empty()}}};var s=function(){$("#textHeader").html("Text: Loading");$("#textContent").html("");$("#textContent").unbind("mouseup").mouseup(A);$.ajax({url:j.environment.text.doc,success:function(D){D=D.replace(/<hr[^>]*>/g,"");$("#textContent").html(D);$("#textHeader").html('Text: <span class="titleName">'+j.environment.text.title+" | "+j.environment.text.locus+"</span>");k();j.environment.text.dropdown=g;$("#textHeader").unbind("click").click(function(H){H.stopPropagation();var F=$("#headerDropdown");if(!j.ui.dropdownShowing){j.ui.dropdownShowing=true;var J=function(){var K=$("#textHeader");var L=K.offset();F.offset({top:0,left:0});F.html(j.environment.text.dropdown);F.offset({top:L.top+K.height(),left:L.left});F.innerWidth(K.outerWidth())};J();$(window).unbind("resize").resize(J);$(document).click(function(){m()});if(j.environment.text.next!=undefined){var I=$(F.find("#nextSeg").get(0));I.addClass("btn-outline-primary").removeClass("btn-outline-secondary disabled noPointer");I.unbind("click").click(function(K){K.stopPropagation();I.html("Loading...");f(j.environment.text.next)})}if(j.environment.text.prev!=undefined){var E=$(F.find("#prevSeg").get(0));E.addClass("btn-outline-primary").removeClass("btn-outline-secondary disabled noPointers");E.unbind("click").click(function(K){K.stopPropagation();E.html("Loading...");f(j.environment.text.prev)})}var G=$(F.find("#newSeg").get(0));G.unbind("click").click(function(){var K=$("#newSegDiv");K.fadeIn();K.find("#location").text(j.environment.text.title+" "+j.environment.text.locus);K.find("#perseusShortcut").text(j.environment.text.shortcut);K.find("#newSegCloseButton").unbind("click").click(function(){K.fadeOut()});K.find("#newSegContent").unbind("click").click(function(L){L.stopPropagation()});K.unbind("click").click(function(){K.fadeOut()});K.find("#newSegQuery").unbind("keydown").keydown(function(L){if(L.keyCode==13){t($("#newSegQueryButton"),$("#newSegQuery"),false)}});K.find("#newSegQueryButton").unbind("click").click(function(){t($("#newSegQueryButton"),$("#newSegQuery"),false)});K.find("#newSegQuery").focus()});F.find("#saveButton").unbind("click").click(function(K){j.file.save(j.environment.text.title+".json")});F.fadeIn()}else{m()}})}})};var y=function(D){j.environment.dictionary.current=D;$("#dictionaryHeader").html('Dictionary: <span class="dictLemma">'+D.wordTitle+'</span> <span class="locus">'+D.loc+"</span>");$("#dictionaryContent").html(D.data)};var n=function(){var D=j.environment.dictionary.current;$.each(j.environment.dictionary.cache,function(E,F){p(F.wordUrl.replace(i,""),F.wordTitle,F.loc,true)});y(D)};var p=function(E,I,F,H){var D=i+E;if(H==undefined){H=false}var G=false;$.each(j.environment.dictionary.cache,function(J,K){if(K.wordUrl==D){y(K);G=true}});if(G&&!H){return}if(!G){$.ajax({url:D,success:function(J){J=J.replace(/<img[^>]*>/g,"");var K=$(J).find("#main_col").get(0);$("#dictionaryContent").html(K.innerHTML);$("#dictionaryContent table").addClass("table table-sm table-striped");var L="<button class='btn btn-sm btn-outline-primary btn-xs' onclick='andromeda.search.addDictNote(event, this)'>+Notes</button>";$("#dictionaryContent .lemma_header").append(L);$("#dictionaryContent .word_freq").remove();$('#dictionaryContent a[href="#lexicon"]').each(function(M,N){$(N).closest(".lemma").append(N);$(N).addClass("btn btn-primary btn-sm btn-xs lexLink");$(N).removeAttr("onclick");$(N).prop("onclick",null);$(N).attr("href","#");var O=$(N).attr("id");$(N).attr("id",O.substr(0,O.length-5))});$("#dictionaryContent p").remove();if($("#dictionaryContent").html().trim().length==0){$("#dictionaryContent").html("<h3>Sorry!</h3><p>It looks like no result could be found for that word.</p>")}$("#dictionaryContent").find(".lexLink").attr("onclick","andromeda.search.loadLexicon(event, this);");o(I,$("#dictionaryContent").html(),D,F);y(j.environment.dictionary.cache[0])}})}$("#dictionaryHeader").unbind("click").click(function(K){K.stopPropagation();var J=$("#headerDropdown");if(!j.ui.dropdownShowing){j.ui.dropdownShowing=true;var L=function(){var M=$("#dictionaryHeader");var N=M.offset();J.offset({top:0,left:0});J.html(j.environment.dictionary.dropdown);J.offset({top:N.top+M.height(),left:N.left});J.innerWidth(M.outerWidth())};L();$(window).unbind("resize").resize(L);$(document).click(function(){m()});J.find(".dropdownLink").each(function(N,P){var M=$("#dictionaryHeader").text().replace("Dictionary:","").trim().replace(" ","").replace(" ","");var O=$(P).text().trim().replace(" ","");if(M!=O){return}$($(P).find(".dropdownIcon").get(0)).addClass("dropdownActiveIcon")});J.fadeIn();J.find(".dropdownLink").click(function(M){var N=j.environment.dictionary.cache[$(this).attr("resultIndex")];y(N)})}else{m()}})};var q=function(F,E){F.stopPropagation();var D=$(E).parent().get(0);var G=$(D).find("h4").get(0);var H=$(D).find(".lemma_definition").get(0);j.environment.note.toAdd={type:"dict",locus:j.environment.dictionary.current.loc,text:j.environment.dictionary.current.wordTitle,data:G.textContent+"&nbsp;=&nbsp;"+H.textContent};x(undefined)};var r=function(I,H){I.stopPropagation();var J=H.textContent;var D=$(H).closest(".lemma").find("h4").get(0).textContent;var G=D+"&nbsp;<span class='lexiconName'>("+J+")</span>";var E=u+"?doc="+H.id;var F=false;$.each(j.environment.dictionary.cache,function(K,L){if(L.wordUrl==E){y(L);F=true}});if(F){return}$.ajax({url:E,success:function(K){o(G,K,E,"");y(j.environment.dictionary.cache[0])}})};var o=function(H,G,E,F){var D={wordTitle:H,data:G,wordUrl:E,loc:F};j.environment.dictionary.cache.unshift(D);if(j.environment.dictionary.cache.length>v){j.environment.dictionary.cache.pop()}l()};var l=function(){j.environment.dictionary.dropdown="";$.each(j.environment.dictionary.cache,function(D,E){j.environment.dictionary.dropdown+="<div class='dropdownLink' resultIndex="+D+"><span class='dropdownIcon'/><span class='dictLemma'>"+E.wordTitle+'</span><span class="locus">'+E.loc+"</span></div>"})};var k=function(){$(".text a").unbind("click").attr("onclick","");$(".text a").click(function(F){F.preventDefault();var E=$(this).text();var D=d(this);p($(this).attr("href"),E,D)})};var d=function(H){var G=j.environment.text.locus;if($(H.parentNode).is("a")){H=H.parentNode}var F=$(H).prevAll("span").get(0);var D=(F==undefined)?"":F.textContent;var E=G.split(", ").pop();if(D.length<1){if(E.startsWith("Book")){D="1"}else{if(E.startsWith("Chapter")){if(E.indexOf(".")!=-1){D=""}else{D="1"}}else{if(E.startsWith("Poem")){D=""+($(H).prevAll("br").length+1)}else{if(E.startsWith("Lines")){D=E.split(" ")[1].split("-")[0]}}}}}if(E.startsWith("Lines")){G=G.replace(", "+E,"")}if(D.length>0){G+="."}return G+D};var B=function(){$("#loadFromPerseusButton").click(function(){t($("#loadFromPerseusButton"),$("#loadFromPerseusQuery"))});$("#loadFromPerseusQuery").keydown(function(D){if(D.keyCode==13){t($("#loadFromPerseusButton"),$("#loadFromPerseusQuery"))}});$("#loadFromFileButton").change(function(D){j.file.load(D.target.files[0])})};j.util={ucfirst:function(G){var H=G.split(" ");var F=[];var D;for(var E in H){D=H[E].toLowerCase();D=D.charAt(0).toUpperCase()+D.substr(1);F.push(D)}return F.join(" ")},getSelected:function(){var D="";if(window.getSelection){D=window.getSelection()}else{if(document.getSelection){D=document.getSelection()}else{if(document.selection){D=document.selection.createRange().text}}}return D}};j.search={perseus:t,loadLexicon:r,addNote:x,addDictNote:q,removeNote:e};j.ui={registerClickHandlers:B,dropdownShowing:false};j.file={save:function z(F){var D="data:text/json;charset=utf-8,"+encodeURI(JSON.stringify(j.environment));var E=document.createElement("a");E.download=F;E.href=D;document.body.appendChild(E);E.click();document.body.removeChild(E);$(E).remove()},load:function(E){var D=new FileReader();D.onload=(function(G){var H=G.currentTarget.result;var F=JSON.parse(decodeURI((H)));$(".greyed-out").removeClass("greyed-out");m();j.environment=F;s();w();$("#noteContent").html("");$("#dictionaryContent").html("");$.each(j.environment.note.all,function(I,J){j.environment.note.toAdd=J;x()});n()});D.readAsText(E)}};j.environment={text:{},translations:[],dictionary:{cache:[]},note:{all:[],toAdd:{}}}})(andromeda);$(document).ready(function(){andromeda.ui.registerClickHandlers();$("#headerDropdown").hide();$("#addNote").hide();$("#newSegDiv").hide()});