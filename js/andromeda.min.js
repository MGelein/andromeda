"use strict";var andromeda={version:0.1,author:"Mees Gelein"};(function(j){var s="http://www.perseus.tufts.edu/hopper/loadquery";var h="http://www.perseus.tufts.edu/hopper/searchresults?q=";var i="http://www.perseus.tufts.edu/hopper/";var t=10;var g="<div class='row'><hr><div class='col-sm-12 text-center'><h4>Navigation</h4></div><div class='col-sm-6 text-center'><span id='prevSeg' class='greyed-out'>◀&nbsp;Previous Segment</span></div><div class='col-sm-6 text-center'><span id='nextSeg' class='greyed-out'>&nbsp;Next Segment&nbsp;▶</span></div><hr><div class='col-sm-12 text-center'><h4>Save &amp; Load</h4></div></div>";var r=function(){var B=$("#loadFromPerseusQuery").val().trim();$("#loadFromPerseusQuery").val("");if(B.length==0){return}$("#loadFromPerseusButton").val("Loading...").removeClass("btn-primary").addClass("btn-warning");var A=B;if(!B.startsWith("http")){A=h+encodeURI(B)}$("#noteContent").html("");$("#dictionaryContent").html("");f(A)};var f=function(A){j.environment.translations=[];j.environment.text={};$.ajax({url:A,success:function(D){if(D.indexOf("<title>Perseus Search results</title>")!=-1||D.indexOf('<link href="/js/perseusld/perseusld.css" rel="stylesheet" type="text/css"/>')==-1){$("#loadFromPerseusButton").val("Not A Known Text").removeClass("btn-warning").addClass("btn-danger");setTimeout(function(){$("#loadFromPerseusButton").val("Load From Perseus").removeClass("btn-danger").addClass("btn-primary")},2000)}else{D=D.replace(/<img/g,"<span");var C=$(D);j.environment.text.locus="";C.find(".current").each(function(K,L){var J=$(L).attr("title");J=j.util.ucfirst(J);J=J.trim();if(J.indexOf("ection")!=-1){j.environment.text.locus+=J.replace("Section ",".")}else{j.environment.text.locus+=", "+J}});j.environment.text.locus=j.environment.text.locus.substr(2);var G=C.find(".current").filter(":last").get(0);j.environment.text.doc=s+$(G).attr("href");j.environment.text.title=$(C.find("#header_text").get(0)).find("h1").get(0).textContent;var F=C.find('.arrow span[alt="next"]').get(0);var H=C.find('.arrow span[alt="previous"]').get(0);if(F!=undefined){j.environment.text.next=i+$(F).parent().attr("href")}else{j.environment.text.next=undefined}if(H!=undefined){j.environment.text.prev=i+$(H).parent().attr("href")}else{j.environment.text.prev=undefined}q();var E=0;while(true){var I=C.find("#translation"+E+" .header");if(I.length<1){break}var B=I.get(0);j.environment.translations.push({title:B.textContent.split("\n")[3],doc:s+$($(B).find(".toggle").get(1)).attr("href").replace("text","")});E++}u()}$(".greyed-out").removeClass("greyed-out");l()}})};var z=function(A,B){$("#translationContent").html(A);$("#translationHeader").html('Translation: <span class="titleName">'+B+"</span>")};var u=function(){$("#translationContent").html("");j.environment.translations.dropdown="";$.each(j.environment.translations,function(A,B){$.ajax({url:B.doc,success:function(C){C=C.replace(/<hr[^>]*>/g,"");C=C.replace(/<img[^>]*>/g,"");B.data=C;j.environment.translations.dropdown+="<div class='dropdownLink' resultIndex='"+A+"'><span class='dropdownIcon'/>"+B.title+"</div>";if(A==0){z(C,B.title)}}})});$("#translationHeader").unbind("click").click(function(B){B.stopPropagation();var A=$("#headerDropdown");if(!j.ui.dropdownShowing){j.ui.dropdownShowing=true;var C=function(){var D=$("#translationHeader");var E=D.offset();A.offset({top:0,left:0});A.html(j.environment.translations.dropdown);A.offset({top:E.top+D.height(),left:E.left});A.innerWidth(D.outerWidth())};C();$(window).unbind("resize").resize(C);$(document).click(function(){l()});A.find(".dropdownLink").each(function(D,E){if($("#translationHeader").text().indexOf($(E).text())==-1){return}$($(E).find(".dropdownIcon").get(0)).addClass("dropdownActiveIcon")});A.fadeIn();A.find(".dropdownLink").click(function(D){z(j.environment.translations[$(this).attr("resultIndex")].data,$(this).text())})}else{l()}})};var l=function(){var A=$("#headerDropdown");$(window).unbind("resize");$(document).unbind("click");j.ui.dropdownShowing=false;A.html("");A.offset({top:0,left:0});A.innerWidth(0);A.hide()};var x=function(A){var B=j.util.getSelected();if(B.isCollapsed){a();return}var C=B.anchorNode;var F=B.focusNode;if(B.toString().trim().length==0){return}if(C.compareDocumentPosition(F)==2){var E=F;F=C;C=E}var H=d(C);var G=$("#addNote");var I={locus:H,text:B.toString()};j.environment.note.toAdd=I;var D=function(){if($(C.parentNode).is("a")){C=C.parentNode}var J=$(C);if(!J.is("a")){J=J.prev()}var K=J.offset();if(K==undefined){return}G.offset({top:0,left:0});G.offset({top:K.top-J.height()*2,left:K.left})};D();$(window).unbind("resize").resize(D);$(document).mousedown(a);G.fadeIn()};var v=function(C){if(C!=undefined){C.stopPropagation()}a();var B=j.environment.note.toAdd;var E=B.text;E=E.replace(/[\n\r]/g," ");B.text=E;var D=E.split(" ");var A=E;if(D.length>4){A=D[0]+" "+D[1]+"[..]"+D[D.length-2]+" "+D[D.length-1]}B.blurb=A;c(B)};var c=function(B){var D=B.locus.replace(/ /g,"_").split(".");var E=D[0].split(",_");if(D.length>1){E.push(D[1])}var C="secondLevel";if(E.length==2){C="thirdLevel"}$.each(E,function(G,F){if(G==0){if($("#noteContent").find("#note-"+F).length==0){$("#noteContent").append('<div class="topLevel" id="note-'+F+'"><h5>'+F.replace("_"," ")+"</h5></div>");$("#noteContent").find(".topLevel").sort(function(J,H){var K=$(J).find("h5").get(0).textContent;var I=$(H).find("h5").get(0).textContent;return b(K,I)}).appendTo($("#noteContent"))}}else{if(G==1){if($("#noteContent").find("#note-"+E[0]+"-"+F).length==0){$("#noteContent").find("#note-"+E[0]).append('<div class="'+C+'" id="note-'+E[0]+"-"+F+'"><span class="level2Name">'+F.replace("_"," ")+"</span></div>");$("#note-"+E[0]).find("."+C).sort(function(J,H){var K=$(J).find(".level2Name").get(0).textContent;var I=$(H).find(".level2Name").get(0).textContent;return b(K,I)}).appendTo($("#note-"+E[0]))}}else{if(G==2){if($("#noteContent").find("#note-"+E[0]+"-"+E[1]+"-"+F).length==0){$("#noteContent").find("#note-"+E[0]+"-"+E[1]).append('<div class="thirdLevel" id="note-'+E[0]+"-"+E[1]+"-"+F+'"><span class="level3Name">'+F.replace("_","")+"</span></div>");$("#note-"+E[0]+"-"+E[1]).find(".thirdLevel").sort(function(J,H){var K=$(J).find(".level3Name").get(0).textContent;var I=$(H).find(".level3Name").get(0).textContent;return b(K,I)}).appendTo($("#note-"+E[0]+"-"+E[1]))}}}}});var A="note-"+E.join("-");if(B.data==undefined||B.data.length<1){B.data="[Click To Edit]"}$("#"+A).append('<div class="note"><div class="noteLemma">'+B.blurb+'&nbsp;:&nbsp;<button class="float-right btn btn-outline-primary btn-sm btn-xs removeNoteButton" onclick="andromeda.search.removeNote(this)">✖</button></div><div class="noteData">'+B.data+"</div></div>");$(".noteData").unbind("click").click(function(F){$(this).attr("contenteditable","true");$(this).keydown(function(G){if(G.keyCode==13&&!G.shiftKey){$(this).attr("contenteditable","false")}})})};var e=function(A){var B=$(A).parent().parent();while(B.parent().find(".note").length==1&&B.parent().attr("id")!="noteContent"){B=B.parent()}B.fadeOut().promise().done(function(){this.remove()})};var b=function(G,F){var D=G.split(" ");var B=F.split(" ");var C,E;for(var A=0;A<D.length;A++){E=D[A];C=B[A];if(isNaN(E)||isNaN(C)){if(E<C){return -1}if(E>C){return 1}}else{var I=parseFloat(E);var H=parseFloat(C);if(I<H){return -1}if(I>H){return 1}}}return 0};var a=function(){var A=$("#addNote");A.offset({top:0,left:0});A.hide();$(document).unbind("mousedown");$(window).unbind("resize");if(window.getSelection){if(window.getSelection().empty){window.getSelection().empty()}else{if(window.getSelection().removeAllRanges){window.getSelection().removeAllRanges()}}}else{if(document.selection){document.selection.empty()}}};var q=function(){$("#textHeader").html("Text: Loading");$("#textContent").html("");$("#textContent").unbind("mouseup").mouseup(x);$.ajax({url:j.environment.text.doc,success:function(A){A=A.replace(/<hr[^>]*>/g,"");$("#textContent").html(A);$("#textHeader").html('Text: <span class="titleName">'+j.environment.text.title+" | "+j.environment.text.locus+"</span>");k();j.environment.text.dropdown=g;$("#textHeader").unbind("click").click(function(D){D.stopPropagation();var C=$("#headerDropdown");if(!j.ui.dropdownShowing){j.ui.dropdownShowing=true;var F=function(){var G=$("#textHeader");var H=G.offset();C.offset({top:0,left:0});C.html(j.environment.text.dropdown);C.offset({top:H.top+G.height(),left:H.left});C.innerWidth(G.outerWidth())};F();$(window).unbind("resize").resize(F);$(document).click(function(){l()});if(j.environment.text.next!=undefined){var E=$(C.find("#nextSeg").get(0));E.addClass("textNav").removeClass("greyed-out");E.unbind("click").click(function(G){G.stopPropagation();E.html("Loading...");f(j.environment.text.next)})}if(j.environment.text.prev!=undefined){var B=$(C.find("#prevSeg").get(0));B.addClass("textNav").removeClass("greyed-out");B.unbind("click").click(function(G){G.stopPropagation();B.html("Loading...");f(j.environment.text.prev)})}C.fadeIn()}else{l()}})}})};var w=function(A,C,B){j.environment.dictionary.current={text:C,locus:B,data:""};$("#dictionaryHeader").html('Dictionary: <span class="dictLemma">'+C+'</span> <span class="locus">'+B+"</span>");$("#dictionaryContent").html(A)};var n=function(B,E,C){var A=i+B;var D=false;$.each(j.environment.dictionary.cache,function(F,G){if(G.wordUrl==A){w(G.data,G.wordTitle,G.loc);D=true}});if(D){return}$.ajax({url:A,success:function(F){F=F.replace(/<img[^>]*>/g,"");var G=$(F).find("#main_col").get(0);$("#dictionaryContent").html(G.innerHTML);$("#dictionaryContent table").addClass("table table-sm table-striped");var H="<button class='btn btn-sm btn-outline-primary btn-xs' onclick='andromeda.search.addDictNote(event, this)'>+Notes</button>";$("#dictionaryContent .lemma_header").append(H);$("#dictionaryContent .word_freq").remove();$('#dictionaryContent a[href="#lexicon"]').each(function(I,J){$(J).closest(".lemma").append(J);$(J).addClass("btn btn-primary btn-sm btn-xs lexLink");$(J).removeAttr("onclick");$(J).prop("onclick",null);$(J).attr("href","#");var K=$(J).attr("id");$(J).attr("id",K.substr(0,K.length-5))});$("#dictionaryContent p").remove();if($("#dictionaryContent").html().trim().length==0){$("#dictionaryContent").html("<h3>Sorry!</h3><p>It looks like no result could be found for that word.</p>")}$("#dictionaryContent").find(".lexLink").attr("onclick","andromeda.search.loadLexicon(event, this);");w($("#dictionaryContent").html(),E,C);m(E,$("#dictionaryContent").html(),A,C);$("#dictionaryHeader").unbind("click").click(function(J){J.stopPropagation();var I=$("#headerDropdown");if(!j.ui.dropdownShowing){j.ui.dropdownShowing=true;var K=function(){var L=$("#dictionaryHeader");var M=L.offset();I.offset({top:0,left:0});I.html(j.environment.dictionary.dropdown);I.offset({top:M.top+L.height(),left:M.left});I.innerWidth(L.outerWidth())};K();$(window).unbind("resize").resize(K);$(document).click(function(){l()});I.find(".dropdownLink").each(function(M,O){var L=$("#dictionaryHeader").text().replace("Dictionary:","").trim().replace(" ","").replace(" ","");var N=$(O).text().trim().replace(" ","");if(L!=N){return}$($(O).find(".dropdownIcon").get(0)).addClass("dropdownActiveIcon")});I.fadeIn();I.find(".dropdownLink").click(function(L){var M=j.environment.dictionary.cache[$(this).attr("resultIndex")];w(M.data,M.wordTitle,M.loc)})}else{l()}})}})};var o=function(C,B){C.stopPropagation();var A=$(B).parent().get(0);var D=$(A).find("h4").get(0);var E=$(A).find(".lemma_definition").get(0);j.environment.note.toAdd={locus:j.environment.dictionary.current.locus,text:j.environment.dictionary.current.text,data:D.textContent+"&nbsp;=&nbsp;"+E.textContent};v(undefined)};var p=function(F,E){F.stopPropagation();var G=E.textContent;var A=$(E).closest(".lemma").find("h4").get(0).textContent;var D=A+"&nbsp;<span class='lexiconName'>("+G+")</span>";var B=s+"?doc="+E.id;var C=false;$.each(j.environment.dictionary.cache,function(H,I){if(I.wordUrl==B){w(I.data,I.wordTitle,I.loc);C=true}});if(C){return}$.ajax({url:B,success:function(H){m(D,H,B,"");w(H,D,"")}})};var m=function(E,D,B,C){var A={wordTitle:E,data:D,wordUrl:B,loc:C};j.environment.dictionary.cache.unshift(A);if(j.environment.dictionary.cache.length>t){j.environment.dictionary.cache.pop()}j.environment.dictionary.dropdown="";$.each(j.environment.dictionary.cache,function(F,G){j.environment.dictionary.dropdown+="<div class='dropdownLink' resultIndex="+F+"><span class='dropdownIcon'/><span class='dictLemma'>"+G.wordTitle+'</span><span class="locus">'+G.loc+"</span></div>"})};var k=function(){$(".text a").unbind("click").attr("onclick","");$(".text a").click(function(C){C.preventDefault();var B=$(this).text();var A=d(this);n($(this).attr("href"),B,A)})};var d=function(E){var D=j.environment.text.locus;if($(E.parentNode).is("a")){E=E.parentNode}var C=$(E).prevAll("span").get(0);var A=(C==undefined)?"":C.textContent;var B=D.split(", ").pop();if(A.length<1){if(B.startsWith("Book")){A="1"}else{if(B.startsWith("Chapter")){if(B.indexOf(".")!=-1){A=""}else{A="1"}}else{if(B.startsWith("Poem")){A=""+($(E).prevAll("br").length+1)}else{if(B.startsWith("Lines")){A=B.split(" ")[1].split("-")[0]}}}}}if(B.startsWith("Lines")){D=D.replace(", "+B,"")}if(A.length>0){D+="."}return D+A};var y=function(){$("#loadFromPerseusButton").click(function(){andromeda.search.perseus()});$("#loadFromPerseusQuery").keydown(function(A){if(A.keyCode==13){r()}})};j.util={ucfirst:function(D){var E=D.split(" ");var C=[];var A;for(var B in E){A=E[B].toLowerCase();A=A.charAt(0).toUpperCase()+A.substr(1);C.push(A)}return C.join(" ")},getSelected:function(){var A="";if(window.getSelection){A=window.getSelection()}else{if(document.getSelection){A=document.getSelection()}else{if(document.selection){A=document.selection.createRange().text}}}return A}};j.search={perseus:r,loadLexicon:p,addNote:v,addDictNote:o,removeNote:e};j.ui={registerClickHandlers:y,dropdownShowing:false};j.environment={text:{},translations:[],dictionary:{cache:[]},note:{all:[],toAdd:{}}}})(andromeda);$(document).ready(function(){andromeda.ui.registerClickHandlers();$("#headerDropdown").hide();$("#addNote").hide()});